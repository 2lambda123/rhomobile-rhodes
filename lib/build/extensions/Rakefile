require 'fileutils'

def build_extension()
  args = []

  cd File.dirname($project_path)
  $project_path = File.basename($project_path)
  
  if ENV['RHO_PLATFORM'] == 'wm' || ENV['RHO_PLATFORM'] == 'win32'

    args = ["/M4", "\"#{$project_path}\"", "\"#{$build_config}|#{$sdk}\"" ]

  elsif ENV['RHO_PLATFORM'] == 'wp8'
  
    args = [$project_path, "/property:Configuration="+$build_config+" /property:Platform="+$sdk + " /property:VisualStudioVersion=11.0", '/t:Build']
    
  else
    fail "This rakefile support only Windows platforms(WM, CE, Desktop and WP8)"
  end

  cmdline = "\"" + $vcbuild + "\"" + ' ' + args.join(' ')
  puts cmdline
  puts `#{cmdline}`
  
  fail "[#{cmdline}]" unless $? == 0

  if $targetext_dir
    $targetext_dir = File.join($targetext_dir,$extname) unless $copy_csharp_files
    mkdir_p $targetext_dir
    file_to_copy = File.join($target_temp_dir, $extname + ($copy_csharp_files ? "Lib" : "") + ".lib")
    puts "copy file #{file_to_copy} to #{$targetext_dir}"
    cp_r file_to_copy, $targetext_dir if File.exist?(file_to_copy)
    if $copy_csharp_files
      file_to_copy = File.join($target_temp_dir, $extname + "Runtime.lib")
      puts "copy file #{file_to_copy} to #{$targetext_dir}"
      cp_r file_to_copy, $targetext_dir if File.exist?(file_to_copy)

      file_to_copy = File.join($target_temp_dir, $extname + "Runtime.dll")
      puts "copy file #{file_to_copy} to #{$targetext_dir}"
      cp_r file_to_copy, $targetext_dir_csharp if File.exist?(file_to_copy)

      file_to_copy = File.join($target_temp_dir, $extname + "Runtime.exp")
      puts "copy file #{file_to_copy} to #{$targetext_dir}"
      cp_r file_to_copy, $targetext_dir_csharp if File.exist?(file_to_copy)

      file_to_copy = File.join($target_temp_dir, $extname + "Runtime.winmd")
      puts "copy file #{file_to_copy} to #{$targetext_dir}"
      cp_r file_to_copy, $targetext_dir_csharp if File.exist?(file_to_copy)

      file_to_copy = File.join($target_temp_dir, $extname + "Impl.dll")
      puts "copy file #{file_to_copy} to #{$targetext_dir}"
      cp_r file_to_copy, $targetext_dir_csharp if File.exist?(file_to_copy)
    end
  end

  if $targetext_dir2
    mkdir_p $targetext_dir2
    file_to_copy = File.join($target_temp_dir, $extname + ".lib")
    puts "copy file #{file_to_copy} to #{$targetext_dir2}"
    cp_r file_to_copy, $targetext_dir2
  end
  
end

namespace "build" do
  task :config do
    $target_temp_dir = ENV['TARGET_TEMP_DIR']
    $targetext_dir = ENV['TARGET_EXT_DIR']
    $targetext_dir2 = ENV['TARGET_EXT_DIR_SIM']
    $targetext_dir_csharp = ENV['TARGET_EXT_DIR_CSHARP']
    $extname = ENV['RHO_EXT_NAME']
    $copy_csharp_files = (!ENV['BUILD_CSHARP_IMPL'].nil?) && (ENV['BUILD_CSHARP_IMPL'] == "yes")

    $tempdir = ENV['TEMP_FILES_DIR']
    raise "TEMP_FILES_DIR is not set" if $tempdir.nil?

    $rootdir = ENV['RHO_ROOT']
    raise "RHO_ROOT is not set" if $rootdir.nil?

    $vcbuild = ENV['VCBUILD']
    raise "VCBUILD is not set" if $vcbuild.nil?

    $sdk = ENV['SDK']
	raise "SDK is not set" if $sdk.nil?
	
	$build_config = ENV['RHO_BUILD_CONFIG']
    raise "RHO_BUILD_CONFIG is not set" if $build_config.nil?

	$project_path = ENV['RHO_PROJECT_PATH']
    raise "RHO_PROJECT_PATH is not set" if $project_path.nil?

  end

  task :all => :config do

    build_extension()
  end
end

task :default => "build:all"
